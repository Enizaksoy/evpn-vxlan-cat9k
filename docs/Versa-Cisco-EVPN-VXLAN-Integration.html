<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OnPrem Multi-Vendor EVPN VXLAN - Cisco / Versa / Cumulus</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;color:#172b4d;background:#fff;line-height:1.6;font-size:14px}

/* ---- wiki layout ---- */
.wiki-wrap{display:flex;min-height:100vh}
.sidebar{width:260px;background:#f4f5f7;border-right:1px solid #dfe1e6;padding:20px 0;position:fixed;top:0;left:0;bottom:0;overflow-y:auto}
.sidebar .logo{padding:16px 20px;font-size:15px;font-weight:700;color:#0052cc;border-bottom:1px solid #dfe1e6;margin-bottom:8px}
.sidebar ul{list-style:none;padding:0}
.sidebar li{margin:0}
.sidebar li a{display:block;padding:7px 20px;color:#42526e;text-decoration:none;font-size:13px;border-left:3px solid transparent;transition:all .15s}
.sidebar li a:hover{background:#ebecf0;color:#0052cc}
.sidebar li a.active{background:#deebff;color:#0052cc;border-left-color:#0052cc;font-weight:600}
.sidebar li.section{padding:16px 20px 4px;font-size:11px;font-weight:700;text-transform:uppercase;color:#6b778c;letter-spacing:.5px}

.main{margin-left:260px;max-width:980px;padding:32px 48px 80px}

/* ---- breadcrumb ---- */
.breadcrumb{font-size:12px;color:#6b778c;margin-bottom:8px}
.breadcrumb a{color:#0052cc;text-decoration:none}
.breadcrumb a:hover{text-decoration:underline}

/* ---- headings ---- */
h1.page-title{font-size:28px;font-weight:600;color:#172b4d;margin:0 0 6px;line-height:1.2}
.page-meta{font-size:12px;color:#6b778c;margin-bottom:28px;padding-bottom:16px;border-bottom:1px solid #dfe1e6}

h2{font-size:20px;font-weight:600;color:#172b4d;margin:40px 0 16px;padding-bottom:8px;border-bottom:2px solid #0052cc}
h3{font-size:16px;font-weight:600;color:#172b4d;margin:28px 0 12px}
h4{font-size:14px;font-weight:600;color:#172b4d;margin:20px 0 8px}

/* ---- paragraph and links ---- */
p{margin:0 0 14px;color:#172b4d}
a{color:#0052cc;text-decoration:none}
a:hover{text-decoration:underline}

/* ---- tables ---- */
table{width:100%;border-collapse:collapse;margin:16px 0 24px;font-size:13px}
th{background:#f4f5f7;color:#172b4d;font-weight:600;text-align:left;padding:10px 12px;border:1px solid #dfe1e6}
td{padding:8px 12px;border:1px solid #dfe1e6;vertical-align:top}
tr:hover td{background:#fafbfc}

/* ---- code blocks ---- */
pre{background:#f4f5f7;border:1px solid #dfe1e6;border-radius:3px;padding:16px;overflow-x:auto;font-family:'SFMono-Regular',Consolas,'Liberation Mono',Menlo,monospace;font-size:12px;line-height:1.5;margin:12px 0 20px;color:#172b4d}
pre.dark{background:#1e1e1e;color:#d4d4d4;border-color:#333}
code{background:#f4f5f7;padding:1px 5px;border-radius:3px;font-family:'SFMono-Regular',Consolas,monospace;font-size:12px;color:#e53e3e}

/* ---- info panels (confluence style) ---- */
.panel{border-radius:3px;padding:16px 20px;margin:16px 0 20px;position:relative}
.panel::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;border-radius:3px 0 0 3px}
.panel-info{background:#deebff;color:#0747a6}.panel-info::before{background:#0052cc}
.panel-success{background:#e3fcef;color:#006644}.panel-success::before{background:#00875a}
.panel-warning{background:#fffae6;color:#172b4d}.panel-warning::before{background:#ff991f}
.panel-error{background:#ffebe6;color:#bf2600}.panel-error::before{background:#de350b}
.panel strong{display:block;margin-bottom:4px}

/* ---- badges ---- */
.badge{display:inline-block;padding:2px 8px;border-radius:3px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.3px}
.badge-cisco{background:#0052cc;color:#fff}
.badge-versa{background:#ff5630;color:#fff}
.badge-cumulus{background:#00875a;color:#fff}
.badge-ok{background:#00875a;color:#fff}
.badge-fixed{background:#ff991f;color:#172b4d}

/* ---- topology image ---- */
.topology-wrap{margin:20px 0;text-align:center;background:#fafbfc;border:1px solid #dfe1e6;border-radius:3px;padding:16px}
.topology-wrap img,.topology-wrap svg{max-width:100%;height:auto}

/* ---- columns ---- */
.cols{display:flex;gap:24px;margin:16px 0}
.cols>div{flex:1}

/* ---- hex dump ---- */
.hex{font-family:'SFMono-Regular',Consolas,monospace;font-size:12px}
.hex .hl-red{color:#de350b;font-weight:700}
.hex .hl-green{color:#00875a;font-weight:700}

/* ---- bit diagram ---- */
.bit-diagram{background:#f4f5f7;border:1px solid #dfe1e6;border-radius:3px;padding:16px;margin:12px 0;overflow-x:auto;font-family:'SFMono-Regular',Consolas,monospace;font-size:12px;line-height:1.4}

/* ---- expand/collapse ---- */
details{margin:12px 0}
details>summary{cursor:pointer;padding:8px 12px;background:#f4f5f7;border:1px solid #dfe1e6;border-radius:3px;font-weight:600;font-size:13px;color:#0052cc;user-select:none}
details>summary:hover{background:#ebecf0}
details[open]>summary{border-radius:3px 3px 0 0;border-bottom:none}
details>.detail-body{border:1px solid #dfe1e6;border-top:none;border-radius:0 0 3px 3px;padding:16px}

/* ---- responsive ---- */
@media(max-width:900px){.sidebar{display:none}.main{margin-left:0;padding:20px 24px}}
@media print{.sidebar{display:none}.main{margin-left:0;padding:20px}h2{page-break-after:avoid}pre{page-break-inside:avoid}}
</style>
</head>
<body>

<!-- ============== SIDEBAR ============== -->
<div class="wiki-wrap">
<nav class="sidebar">
  <div class="logo">EVPN VXLAN Fabric</div>
  <ul>
    <li class="section">Overview</li>
    <li><a href="#s1" class="active">Summary</a></li>
    <li><a href="#s2">Topology</a></li>
    <li><a href="#s3">Device Inventory</a></li>
    <li><a href="#s4">VLAN / VNI Mapping</a></li>
    <li class="section">Configuration</li>
    <li><a href="#s5">Underlay (OSPF)</a></li>
    <li><a href="#s6">BGP EVPN Overlay</a></li>
    <li><a href="#s7">L2VPN EVPN Instances</a></li>
    <li><a href="#s8">Cumulus Linux (NVUE)</a></li>
    <li class="section">Verification</li>
    <li><a href="#s9">NVE Peers</a></li>
    <li><a href="#s10">MAC Learning</a></li>
    <li class="section">Troubleshooting</li>
    <li><a href="#s11">VXLAN-GBP Issue</a></li>
    <li><a href="#s12">GBP Fix &amp; Resolution</a></li>
    <li><a href="#s13">Command Reference</a></li>
    <li><a href="#s14">Lessons Learned</a></li>
  </ul>
</nav>

<!-- ============== MAIN CONTENT ============== -->
<div class="main">

<div class="breadcrumb"><a href="#">Home</a> / <a href="#">Network Engineering</a> / <a href="#">EVPN VXLAN</a> / OnPrem Multi-Vendor</div>

<h1 class="page-title">OnPrem Multi-Vendor EVPN VXLAN Integration</h1>
<div class="page-meta">
  Cisco Catalyst 9300 &bull; Versa FlexVNF &bull; Cumulus Linux (NVIDIA) &nbsp;|&nbsp; Version 2.1 &nbsp;|&nbsp; Last updated: February 16, 2026 &nbsp;|&nbsp; INTERNAL
</div>

<!-- ==================== 1 ==================== -->
<h2 id="s1">1. Summary</h2>

<p>This document covers the integration of a multi-vendor BGP EVPN VXLAN fabric for Layer 2 extension of <strong>VLAN 1151 (VNI 401151)</strong> across four leaf VTEPs. The fabric uses iBGP with a route reflector, OSPF underlay, and ingress replication for BUM traffic.</p>

<div class="cols">
<div>
<h4>Fabric Components</h4>
<table>
  <tr><td><span class="badge badge-cisco">CISCO</span> sw1</td><td>Spine / BGP Route Reflector</td></tr>
  <tr><td><span class="badge badge-cisco">CISCO</span> sw2</td><td>Leaf VTEP</td></tr>
  <tr><td><span class="badge badge-cisco">CISCO</span> sw3</td><td>Leaf VTEP</td></tr>
  <tr><td><span class="badge badge-versa">VERSA</span> FlexVNF</td><td>SD-WAN VTEP</td></tr>
  <tr><td><span class="badge badge-cumulus">CUMULUS</span> Nvidia</td><td>Leaf VTEP</td></tr>
</table>
</div>
<div>
<h4>Status</h4>
<table>
  <tr><td>OSPF Adjacencies</td><td><span class="badge badge-ok">FULL</span></td></tr>
  <tr><td>BGP EVPN Peers</td><td><span class="badge badge-ok">Established</span></td></tr>
  <tr><td>VXLAN Tunnels</td><td><span class="badge badge-ok">4 VTEPs UP</span></td></tr>
  <tr><td>Cross-vendor MAC Learning</td><td><span class="badge badge-ok">Working</span></td></tr>
  <tr><td>VXLAN-GBP (Multi-Vendor)</td><td><span class="badge badge-fixed">FIXED</span></td></tr>
</table>
</div>
</div>

<!-- ==================== 2 ==================== -->
<h2 id="s2">2. Topology</h2>

<div class="topology-wrap">
  <img src="data:image/svg+xml;base64," alt="" style="display:none"/>
  <object data="../diagrams/topology.svg" type="image/svg+xml" style="width:100%;max-width:1100px;"></object>
</div>

<p><em>Diagram: All four leaf VTEPs connected to sw1 spine via OSPF point-to-point links. VXLAN full-mesh tunnels overlay shown in purple dashed lines. Versa sends VXLAN-GBP headers (orange). Cumulus has GBP fix applied (green).</em></p>

<!-- ==================== 3 ==================== -->
<h2 id="s3">3. Device Inventory</h2>

<table>
  <tr><th>Device</th><th>Role</th><th>Platform</th><th>Loopback / VTEP</th><th>OSPF RID</th><th>BGP AS</th><th>Mgmt IP</th></tr>
  <tr><td><span class="badge badge-cisco">CISCO</span> <strong>sw1</strong></td><td>Spine / BGP RR</td><td>Catalyst 9300</td><td>1.1.1.1</td><td>1.1.1.1</td><td>6500</td><td>192.168.20.77</td></tr>
  <tr><td><span class="badge badge-cisco">CISCO</span> <strong>sw2</strong></td><td>Leaf VTEP</td><td>Catalyst 9300</td><td>1.1.1.2</td><td>1.1.1.2</td><td>6500</td><td>192.168.20.76</td></tr>
  <tr><td><span class="badge badge-cisco">CISCO</span> <strong>sw3</strong></td><td>Leaf VTEP</td><td>Catalyst 9300</td><td>1.1.1.3</td><td>1.1.1.3</td><td>6500</td><td>192.168.20.81</td></tr>
  <tr><td><span class="badge badge-versa">VERSA</span> <strong>FlexVNF</strong></td><td>SD-WAN VTEP</td><td>FlexVNF 22.1.4</td><td>1.1.1.4</td><td>12.12.12.10</td><td>6500</td><td>192.168.20.166</td></tr>
  <tr><td><span class="badge badge-cumulus">CUMULUS</span> <strong>Nvidia</strong></td><td>Leaf VTEP</td><td>Cumulus Linux 5.x</td><td>1.1.1.5</td><td>1.1.1.5</td><td>6500</td><td>192.168.20.172</td></tr>
</table>

<h3>Underlay Point-to-Point Links</h3>
<table>
  <tr><th>Link</th><th>sw1 Intf</th><th>sw1 IP</th><th>Remote Intf</th><th>Remote IP</th><th>Subnet</th></tr>
  <tr><td>sw1 &harr; sw2</td><td>Gi1/0/1</td><td>12.12.12.1</td><td>Gi1/0/1</td><td>12.12.12.2</td><td>12.12.12.0/30</td></tr>
  <tr><td>sw1 &harr; sw3</td><td>Gi1/0/2</td><td>12.12.12.5</td><td>Gi1/0/1</td><td>12.12.12.6</td><td>12.12.12.4/30</td></tr>
  <tr><td>sw1 &harr; Versa</td><td>Gi1/0/3</td><td>12.12.12.9</td><td>Vni-0/2</td><td>12.12.12.10</td><td>12.12.12.8/30</td></tr>
  <tr><td>sw1 &harr; Cumulus</td><td>Gi1/0/4</td><td>12.12.12.13</td><td>swp1</td><td>12.12.12.14</td><td>12.12.12.12/30</td></tr>
</table>

<!-- ==================== 4 ==================== -->
<h2 id="s4">4. VLAN / VNI Mapping</h2>

<table>
  <tr><th>VLAN</th><th>Name</th><th>VNI</th><th>Subnet</th><th>Purpose</th><th>Devices</th></tr>
  <tr><td>1101</td><td>VRF1_CORE_VLAN</td><td>50101</td><td>&mdash;</td><td>L3VNI (Core Routing)</td><td>sw2, sw3</td></tr>
  <tr style="background:#deebff"><td><strong>1151</strong></td><td><strong>VRF1_ACCESS_VLAN</strong></td><td><strong>401151</strong></td><td><strong>192.168.1.0/25</strong></td><td><strong>L2 Extension (All VTEPs)</strong></td><td><strong>sw2, sw3, Versa, Cumulus</strong></td></tr>
  <tr><td>1152</td><td>VRF1_ACCESS_VLAN_2</td><td>401152</td><td>192.168.2.0/25</td><td>Access VLAN</td><td>sw2, sw3</td></tr>
  <tr><td>1153</td><td>VRF1_ACCESS_VLAN_3</td><td>401153</td><td>192.168.3.0/25</td><td>Access VLAN</td><td>sw2, sw3</td></tr>
</table>

<!-- ==================== 5 ==================== -->
<h2 id="s5">5. Underlay Configuration (OSPF)</h2>

<h3>5.1 sw1 &mdash; Spine (Cisco IOS-XE)</h3>
<pre class="dark">! sw1 - OSPF underlay + interfaces
router ospf 100
 router-id 1.1.1.1
 auto-cost reference-bandwidth 100000

interface Loopback0
 ip address 1.1.1.1 255.255.255.255
 ip ospf 100 area 100

interface GigabitEthernet1/0/1
 description to sw2
 no switchport
 ip address 12.12.12.1 255.255.255.252
 ip ospf network point-to-point
 ip ospf 100 area 100

interface GigabitEthernet1/0/2
 description to sw3
 no switchport
 ip address 12.12.12.5 255.255.255.252
 ip ospf network point-to-point
 ip ospf 100 area 100

interface GigabitEthernet1/0/3
 description to Versa FlexVNF
 no switchport
 ip address 12.12.12.9 255.255.255.252
 ip mtu 1550
 ip ospf network point-to-point
 ip ospf mtu-ignore
 ip ospf 100 area 100

interface GigabitEthernet1/0/4
 description to Cumulus_Nvidia
 no switchport
 ip address 12.12.12.13 255.255.255.252
 ip mtu 1550
 ip ospf network point-to-point
 ip ospf mtu-ignore
 ip ospf 100 area 100</pre>

<div class="panel panel-warning">
<strong>MTU Mismatch</strong>
Cumulus defaults to MTU 9216. Cisco uses 1550 on this link. <code>ip ospf mtu-ignore</code> is configured on both ends to prevent OSPF ExStart/DBD failures. Alternatively, match MTU on both sides.
</div>

<h3>5.2 Versa &mdash; Underlay OSPF</h3>
<pre class="dark">routing-instances routing-instance Underlay {
    instance-type virtual-router
    networks      [ OSPF_Underlay ]
    evpn-core
    interfaces    [ tvi-0/9005.0 ]

    policy-options {
        redistribution-policy Export-Vtep-To-OSPF {
            term VTEP_IP {
                match { address 1.1.1.4/32 }
                action { accept }
            }
        }
        redistribute-to-ospf Export-Vtep-To-OSPF
    }

    protocols {
        ospf 4023 {
            router-id     12.12.12.10
            area 100 {
                network-name OSPF_Underlay {
                    network-type    point-to-point
                    hello-interval  10
                    dead-interval   40
                }
            }
        }
    }
}</pre>

<h3>5.3 OSPF Verification (sw1)</h3>
<pre>sw1# show ip ospf neighbor

Neighbor ID     Pri   State           Dead Time   Address         Interface
12.12.12.10       0   FULL/  -        00:00:32    12.12.12.10     GigabitEthernet1/0/3
1.1.1.3           0   FULL/  -        00:00:39    12.12.12.6      GigabitEthernet1/0/2
1.1.1.2           0   FULL/  -        00:00:31    12.12.12.2      GigabitEthernet1/0/1
1.1.1.5           0   FULL/  -        00:00:37    12.12.12.14     GigabitEthernet1/0/4</pre>

<div class="panel panel-success"><strong>OSPF Status</strong> All four adjacencies FULL &mdash; sw2, sw3, Versa, Cumulus.</div>

<!-- ==================== 6 ==================== -->
<h2 id="s6">6. BGP EVPN Overlay</h2>

<h3>6.1 sw1 &mdash; Route Reflector</h3>
<pre class="dark">router bgp 6500
 bgp router-id interface Loopback0
 bgp log-neighbor-changes

 template peer-session spine-peer-session
  remote-as 6500
  update-source Loopback0
 exit-peer-session

 neighbor 1.1.1.2 inherit peer-session spine-peer-session
 neighbor 1.1.1.3 inherit peer-session spine-peer-session
 neighbor 1.1.1.4 inherit peer-session spine-peer-session
 neighbor 1.1.1.4 send-community both
 neighbor 1.1.1.5 inherit peer-session spine-peer-session
 neighbor 1.1.1.5 send-community both

 address-family l2vpn evpn
  neighbor 1.1.1.2 activate
  neighbor 1.1.1.2 send-community both
  neighbor 1.1.1.2 route-reflector-client
  neighbor 1.1.1.3 activate
  neighbor 1.1.1.3 send-community both
  neighbor 1.1.1.4 activate
  neighbor 1.1.1.4 send-community both
  neighbor 1.1.1.4 route-reflector-client
  neighbor 1.1.1.5 activate
  neighbor 1.1.1.5 send-community both
  neighbor 1.1.1.5 route-reflector-client
 exit-address-family</pre>

<h3>6.2 Versa &mdash; BGP EVPN</h3>
<pre class="dark">routing-instances routing-instance Underlay {
    protocols {
        bgp 3023 {
            router-id     1.1.1.4
            local-as { as-number 64515 }
            group vxlan_internal {
                type     internal
                family { l2vpn { evpn } }
                local-as 6500
                neighbor 1.1.1.1 {
                    local-address tvi-0/9005.0
                }
            }
        }
    }
}</pre>

<div class="panel panel-info"><strong>Note</strong> Versa uses <code>local-as 6500</code> override to match the fabric AS while keeping its internal AS 64515.</div>

<h3>6.3 BGP Verification (sw1)</h3>
<pre>sw1# show bgp l2vpn evpn summary
BGP router identifier 1.1.1.1, local AS number 6500

Neighbor        V    AS   MsgRcvd MsgSent  TblVer InQ OutQ Up/Down  State/PfxRcd
1.1.1.2         4  6500      224     290     106    0    0 03:03:30       18
1.1.1.3         4  6500      234     233     106    0    0 03:04:07       15
1.1.1.4         4  6500      429     454     106    0    0 03:03:42        1
1.1.1.5         4  6500     1148    1130       0    0    0 00:48:57        2</pre>

<div class="panel panel-success"><strong>BGP Status</strong> All four EVPN peers established. Cumulus: 2 routes (Type-2 + Type-3). Versa: 1 route (Type-3 IMET).</div>

<!-- ==================== 7 ==================== -->
<h2 id="s7">7. L2VPN EVPN Instances</h2>

<h3>7.1 Route Target Mapping</h3>
<table>
  <tr><th>Device</th><th>RD</th><th>Export RT</th><th>Import RT</th></tr>
  <tr><td><span class="badge badge-cisco">CISCO</span> sw2</td><td>1.1.1.2:1151 (auto)</td><td>1151:1</td><td>1151:1, 65000:1151, <strong>2:2</strong></td></tr>
  <tr><td><span class="badge badge-cisco">CISCO</span> sw3</td><td>1.1.1.3:1151 (auto)</td><td>1151:1</td><td>1151:1</td></tr>
  <tr><td><span class="badge badge-versa">VERSA</span></td><td>2L:122</td><td><strong>2:2</strong>, 1151:1</td><td>2:2, 1151:1</td></tr>
  <tr><td><span class="badge badge-cumulus">CUMULUS</span></td><td>1.1.1.5:2 (auto)</td><td>1151:1</td><td>1151:1</td></tr>
</table>

<div class="panel panel-warning"><strong>Route Target</strong> Versa exports RT <code>2:2</code> in addition to <code>1151:1</code>. All devices import <code>1151:1</code> so Versa routes are received. sw2 also imports <code>2:2</code> for completeness.</div>

<h3>7.2 sw2 L2VPN &amp; NVE</h3>
<pre class="dark">l2vpn evpn instance 1151 vlan-based
 encapsulation vxlan
 route-target export 1151:1
 route-target import 1151:1
 route-target import 65000:1151
 route-target import 2:2
!
vlan configuration 1151
 member evpn-instance 1151 vni 401151
!
interface nve1
 no ip address
 source-interface Loopback0
 host-reachability protocol bgp
 member vni 50101 vrf VRF-1
 member vni 401151 ingress-replication
 member vni 401152 ingress-replication local-routing
 member vni 401153 ingress-replication local-routing</pre>

<h3>7.3 Versa Virtual-Switch</h3>

<details>
<summary>Click to expand Versa virtual-switch configuration</summary>
<div class="detail-body">
<pre class="dark">routing-instances routing-instance VERSA-default-switch {
    instance-type       virtual-switch

    bridge-options {
        l2vpn-service-type vlan
    }

    bridge-domains {
        VLAN-1151 {
            vlan-id 1151
            bridge-options {
                bridge-domain-arp-suppression enable
            }
            vxlan { vni 401151 }
        }
    }

    interfaces          [ vni-0/1.1 ]
    route-distinguisher 2L:122
    vrf-both-target     "target:2L:2 target:1151:1"

    protocols {
        evpn {
            vlan-id-list  [ 1151 ]
            encapsulation vxlan
            core-instance Underlay
        }
    }
}</pre>
</div>
</details>

<!-- ==================== 8 ==================== -->
<h2 id="s8">8. Cumulus Linux (NVIDIA) &mdash; NVUE Configuration</h2>

<div class="panel panel-info"><strong>Platform</strong> Cumulus Linux 5.x uses <strong>NVUE</strong> (<code>nv set</code>) as the primary configuration method. Apply changes with <code>nv config apply -y</code>.</div>

<h3>8.1 Complete NVUE Commands</h3>
<pre class="dark"><span style="color:#6a9955"># ── Loopback (VTEP Source) ──</span>
nv set interface lo type loopback
nv set interface lo ip address 1.1.1.5/32

<span style="color:#6a9955"># ── Underlay Link to sw1 ──</span>
nv set interface swp1 type swp
nv set interface swp1 link state up
nv set interface swp1 ip address 12.12.12.14/30
nv set interface swp1 link mtu 9216

<span style="color:#6a9955"># ── OSPF Underlay ──</span>
nv set router ospf enable on
nv set router ospf router-id 1.1.1.5
nv set vrf default router ospf enable on
nv set vrf default router ospf router-id 1.1.1.5
nv set interface lo router ospf enable on
nv set interface lo router ospf area 100
nv set interface swp1 router ospf enable on
nv set interface swp1 router ospf area 100
nv set interface swp1 router ospf network-type point-to-point
nv set interface swp1 router ospf mtu-ignore on

<span style="color:#6a9955"># ── BGP EVPN Overlay ──</span>
nv set router bgp enable on
nv set router bgp autonomous-system 6500
nv set router bgp router-id 1.1.1.5
nv set vrf default router bgp enable on
nv set vrf default router bgp neighbor 1.1.1.1 remote-as internal
nv set vrf default router bgp neighbor 1.1.1.1 type numbered
nv set vrf default router bgp neighbor 1.1.1.1 update-source lo
nv set vrf default router bgp address-family l2vpn-evpn enable on
nv set vrf default router bgp neighbor 1.1.1.1 address-family l2vpn-evpn enable on

<span style="color:#6a9955"># ── VXLAN / NVE ──</span>
nv set nve vxlan enable on
nv set nve vxlan source address 1.1.1.5
nv set evpn enable on

<span style="color:#6a9955"># ── Bridge + VLAN 1151 + VNI ──</span>
nv set bridge domain br_default vlan 1151 vni 401151
nv set evpn vni 401151 route-target export 1151:1
nv set evpn vni 401151 route-target import 1151:1

<span style="color:#6a9955"># ── Access Port (swp2) ──</span>
nv set interface swp2 type swp
nv set interface swp2 link state up
nv set interface swp2 bridge domain br_default
nv set interface swp2 bridge domain br_default stp admin-edge on
nv set interface swp2 bridge domain br_default stp bpdu-guard on

<span style="color:#6a9955"># ── SVI for VLAN 1151 ──</span>
nv set interface vlan1151 type svi
nv set interface vlan1151 vlan 1151
nv set interface vlan1151 ip address 192.168.1.15/25

<span style="color:#6a9955"># ── Apply ──</span>
nv config apply -y</pre>

<h3>8.2 Cumulus Verification</h3>

<pre>cumulus@cumulus:~$ sudo vtysh -c "show ip ospf neighbor"

Neighbor ID     Pri State           Dead Time Address         Interface
1.1.1.1           1 Full/DROther      39.892s 12.12.12.13     swp1:12.12.12.14</pre>

<pre>cumulus@cumulus:~$ sudo vtysh -c "show bgp l2vpn evpn summary"

BGP router identifier 1.1.1.5, local AS number 6500 vrf-id 0
Peers 1, using 23 KiB of memory

Neighbor        V   AS   MsgRcvd  MsgSent  Up/Down  State/PfxRcd  PfxSnt
1.1.1.1         4  6500    1148     1130   00:48:57           25       2</pre>

<pre>cumulus@cumulus:~$ sudo vtysh -c "show evpn vni 401151"

VNI: 401151
 Type: L2
 Vlan: 1151
 Bridge: br_default
 VxLAN interface: vxlan48
 Local VTEP IP: 1.1.1.5
 Remote VTEPs for this VNI:
  1.1.1.4 flood: HER
  1.1.1.3 flood: HER
  1.1.1.2 flood: HER
 Number of MACs (local and remote): 6
 Number of ARPs (local and remote): 6</pre>

<pre>cumulus@cumulus:~$ bridge fdb show dev vxlan48

aa:bb:cc:00:27:00 dst 1.1.1.3 self extern_learn    <span style="color:#6a9955"># sw3 client</span>
aa:bb:cc:00:24:00 dst 1.1.1.2 self extern_learn    <span style="color:#6a9955"># sw2 client</span>
52:54:00:91:2c:07 dst 1.1.1.3 self extern_learn
52:54:00:c4:b4:a1 dst 1.1.1.2 self extern_learn
00:00:00:00:00:00 dst 1.1.1.2 self permanent       <span style="color:#6a9955"># BUM flooding</span>
00:00:00:00:00:00 dst 1.1.1.3 self permanent
00:00:00:00:00:00 dst 1.1.1.4 self permanent</pre>

<div class="panel panel-success"><strong>Cumulus EVPN Status</strong> VNI 401151 active. 3 remote VTEPs discovered. All remote MACs learned via EVPN Type-2 routes. HER active for BUM.</div>

<!-- ==================== 9 ==================== -->
<h2 id="s9">9. NVE Peer Verification</h2>

<pre>sw2# show nve peers vni 401151

Interface  VNI      Type Peer-IP     RMAC/Num_RTs  eVNI     state  UP time
nve1       401151   L2CP 1.1.1.3     3             401151     UP   06:01:13
nve1       401151   L2CP 1.1.1.4     1             401151     UP   00:49:17
nve1       401151   L2CP 1.1.1.5     2             401151     UP   00:48:57</pre>

<pre>cumulus@cumulus:~$ ip -d link show vxlan48

14: vxlan48: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9216
    master br_default state UNKNOWN
    vxlan id 401151 local 1.1.1.5 dstport 4789
    nolearning ttl 64 udpcsum <strong>gbp</strong>
    bridge_slave state <strong>forwarding</strong> learning <strong>off</strong> neigh_suppress <strong>on</strong></pre>

<div class="panel panel-info"><strong>Key Parameters</strong> <code>nolearning</code> = EVPN controls FDB, <code>neigh_suppress</code> = ARP suppression, <code>gbp</code> = VXLAN-GBP enabled (required for interop with any GBP-sending VTEP: Cisco with SGT/GBP, Versa, etc.).</div>

<!-- ==================== 10 ==================== -->
<h2 id="s10">10. MAC Address Learning</h2>

<h3>Versa Bridge Table</h3>
<pre>admin@Cisco-EVPN-Br1-cli> show bridge

ROUTING INSTANCE         BRIDGE     MAC-ADDRESS        TYPE  VLAN  TUNNEL EP
VERSA-default-switch     VLAN-1151  aa:bb:cc:00:27:00  CA    1151  1.1.1.3
VERSA-default-switch     VLAN-1151  aa:bb:cc:00:24:00  CA    1151  1.1.1.2</pre>

<h3>sw2 EVPN MAC Table</h3>
<pre>sw2# show l2vpn evpn mac evi 1151

MAC Address    EVI   VLAN  Next Hop(s)
aabb.cc00.2400 1151  1151  Gi1/0/4:1151    (local)
aabb.cc00.2700 1151  1151  1.1.1.3         (remote - sw3)
aabb.cc00.2f10 1151  1151  1.1.1.4         (remote - Versa)</pre>

<div class="panel panel-success"><strong>Cross-Vendor MAC Learning Confirmed</strong> All VTEPs see each other's client MACs via EVPN Type-2 routes.</div>

<!-- ==================== 11 ==================== -->
<h2 id="s11">11. VXLAN-GBP Interoperability Issue</h2>

<div class="panel panel-error">
<strong>Issue: NET-2026-001 &mdash; Severity: HIGH</strong>
100% data plane packet loss from any GBP-sending VTEP to Cumulus Linux. EVPN control plane is fully operational (BGP sessions up, routes exchanged, NVE peers visible). Root cause: <strong>Multiple vendors</strong> send VXLAN packets with GBP (Group Based Policy) flags (0x88) &mdash; including <strong>Cisco Catalyst 9300</strong> with <code>group-based-policy</code> + CTS/SGT enabled, and <strong>Versa FlexVNF</strong> (GBP always on by default). The Linux kernel VXLAN driver silently drops GBP-flagged packets on non-GBP VXLAN interfaces. This is <strong>not a vendor-specific issue</strong> &mdash; it is a Linux kernel behavior.
</div>

<h3>11.1 What is VXLAN-GBP?</h3>

<p><strong>VXLAN-GBP</strong> (Group Based Policy) is an extension to the standard VXLAN header (<em>draft-smith-vxlan-group-policy</em>). It adds a <strong>Group Policy ID</strong> (SGT) to the VXLAN header for micro-segmentation.</p>

<div class="cols">
<div>
<h4>Standard VXLAN (RFC 7348)</h4>
<div class="bit-diagram">
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|R|R|R|R|<strong style="color:#0052cc">I</strong>|R|R|R|         Reserved (24 bits)                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|              VXLAN Network Identifier (VNI)   |   Reserved    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Flags byte = <strong style="color:#00875a">0x08</strong>  (I-bit only)
</div>
</div>
<div>
<h4>VXLAN-GBP (draft-smith)</h4>
<div class="bit-diagram">
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|<strong style="color:#de350b">G</strong>|R|R|<strong style="color:#de350b">D</strong>|<strong style="color:#0052cc">I</strong>|R|R|<strong style="color:#de350b">A</strong>|<strong style="color:#de350b"> Group Policy ID (16 bits) </strong>|   Reserved    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|              VXLAN Network Identifier (VNI)   |   Reserved    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Flags byte = <strong style="color:#de350b">0x88</strong>  (G-bit + I-bit)
</div>
</div>
</div>

<table>
<tr><th>Bit</th><th>Name</th><th>Description</th></tr>
<tr><td><strong style="color:#de350b">G (bit 0)</strong></td><td>GBP Extension</td><td>When set, indicates GBP header present</td></tr>
<tr><td><strong style="color:#de350b">D (bit 3)</strong></td><td>Don't Learn</td><td>Tells remote VTEP not to learn source MAC</td></tr>
<tr><td><strong style="color:#0052cc">I (bit 4)</strong></td><td>VNI Valid</td><td>Same as standard VXLAN</td></tr>
<tr><td><strong style="color:#de350b">A (bit 7)</strong></td><td>Applied</td><td>Policy already applied at source</td></tr>
<tr><td><strong style="color:#de350b">Group Policy ID</strong></td><td>SGT</td><td>16-bit Security Group Tag</td></tr>
</table>

<h3>11.2 Packet Capture Evidence</h3>

<h4>Evidence A: Versa FlexVNF &rarr; Cumulus (GBP always on)</h4>
<p>Captured on sw1 spine between Cumulus (1.1.1.5) and Versa (1.1.1.4):</p>

<pre class="dark"><span style="color:#6a9955"># tshark -r BGP-EVPN.pcap -Y "vxlan" -T fields -e frame.number -e ip.src -e ip.dst -e vxlan.flags -e vxlan.vni</span>

Frame  Source (outer)    Destination (outer)  Flags   VNI
─────  ────────────────  ───────────────────  ──────  ──────
11     1.1.1.5 Cumulus → 1.1.1.4 Versa       <span style="color:#4ec9b0">0x0800</span>  401151
12     1.1.1.4 Versa  → 1.1.1.5 Cumulus      <span style="color:#f44747">0x8808</span>  401151
13     1.1.1.5 Cumulus → 1.1.1.4 Versa       <span style="color:#4ec9b0">0x0800</span>  401151
14     1.1.1.4 Versa  → 1.1.1.5 Cumulus      <span style="color:#f44747">0x8808</span>  401151
...    (pattern repeats for ALL packets)</pre>

<h4>Evidence B: Cisco sw2 with SGT &rarr; Cumulus (GBP + SGT 100)</h4>
<p>Captured on Cumulus swp1 with <code>tcpdump -i swp1 -n 'udp port 4789' -XX -vvv</code>:</p>

<pre class="dark"><span style="color:#6a9955"># Cisco sw2 (1.1.1.2, group-based-policy ON) → Cumulus (1.1.1.5)</span>
<span style="color:#6a9955"># ICMP Echo Reply: 192.168.1.22 → 192.168.1.11</span>

VXLAN Header (hex): <span style="color:#f44747">88</span> 00 <span style="color:#f44747">00 64</span> 06 1e ff 00
                    ^^       ^^^^^
                    |        Group Policy ID = 0x0064 = <strong style="color:#f44747">SGT 100</strong>
                    Flags = <strong style="color:#f44747">0x88</strong> (G-bit + I-bit = GBP ENABLED)

<span style="color:#6a9955"># Cisco sw3 (1.1.1.3, NO group-based-policy) → Cumulus (1.1.1.5)</span>
<span style="color:#6a9955"># ICMP Echo Reply: 192.168.1.23 → 192.168.1.11</span>

VXLAN Header (hex): <span style="color:#4ec9b0">08</span> 00 00 00 06 1e ff 00
                    ^^
                    Flags = <span style="color:#4ec9b0">0x08</span> (I-bit only = STANDARD VXLAN)</pre>

<div class="panel panel-warning"><strong>Key Finding</strong> Cisco sw2 with <code>group-based-policy</code> + CTS/SGT sends <strong>identical GBP flags (0x88)</strong> as Versa FlexVNF. The only difference is the Group Policy ID value (Cisco inserts the configured SGT tag, e.g., 100). Both cause the <strong>same packet drops</strong> on Cumulus Linux without the <code>gbp</code> flag.</div>

<h3>11.3 Raw Hex Dump Comparison</h3>

<pre class="dark hex"><span style="color:#6a9955">                    Flags Rsvd  GPID    VNI      Rsvd</span>
<span style="color:#6a9955">                    ----- ----  ------  -------  ----</span>
Cisco sw2 (GBP):   <span class="hl-red">88</span>    00    <span class="hl-red">00 64</span>   06 1e ff 00    ← SGT 100 in GPID field
Cisco sw3 (std):   <span class="hl-green">08</span>    00    00 00   06 1e ff 00    ← No GBP, GPID=0
Cumulus (std):     <span class="hl-green">08</span>    00    00 00   06 1e ff 00    ← No GBP, GPID=0
Versa (GBP):      <span class="hl-red">88</span>    00    <span class="hl-red">xx xx</span>   06 1e ff 00    ← GBP enabled, GPID varies</pre>

<h3>11.4 Why This Causes Failure</h3>

<ul>
  <li>Linux kernel VXLAN driver validates header flags strictly</li>
  <li>Without <code>gbp</code> option, kernel expects flags = <code>0x08</code> (I-bit only)</li>
  <li>Receiving <code>0x88</code> (G-bit set) &rarr; packet <strong>silently dropped</strong></li>
  <li>No error, no log, no counter increment, no ICMP unreachable</li>
  <li>Affects <strong>all</strong> GBP-sending VTEPs equally: Cisco with SGT, Versa, or any other vendor using VXLAN-GBP</li>
</ul>

<pre style="background:#fafbfc;text-align:center;font-family:monospace;font-size:12px;line-height:1.6;padding:20px">
                                                 GBP-Sending VTEP       Remote Client
  Cumulus Client        Cumulus VTEP            (Cisco SGT / Versa)     192.168.1.x
  192.168.1.12          1.1.1.5                 1.1.1.2 or 1.1.1.4
       │                    │                          │                      │
       │── ICMP Request ──→ │                          │                      │
       │                    │══ VXLAN flags=0x08 ═════→ │                      │
       │                    │     (standard)            │── ICMP Request ────→ │
       │                    │                          │                      │
       │                    │                          │ ←── ICMP Reply ───── │
       │                    │ ←══ VXLAN flags=0x88 ════ │                      │
       │                    │     (GBP!)               │                      │
       │                 <strong style="color:#de350b">[DROPPED]</strong>                      │                      │
       │              kernel rejects GBP               │                      │
       │              on non-GBP interface             │                      │
</pre>

<h3>11.5 Affected Traffic Flows</h3>
<table>
  <tr><th>Sender</th><th>Receiver</th><th>VXLAN Flags</th><th>Result</th></tr>
  <tr><td><span class="badge badge-cisco">CISCO</span> sw2 (GBP+SGT ON)</td><td><span class="badge badge-cumulus">CUMULUS</span></td><td><strong style="color:#de350b">0x88</strong></td><td><strong style="color:#de350b">DROPPED</strong> (without <code>gbp</code> flag)</td></tr>
  <tr><td><span class="badge badge-versa">VERSA</span> FlexVNF</td><td><span class="badge badge-cumulus">CUMULUS</span></td><td><strong style="color:#de350b">0x88</strong></td><td><strong style="color:#de350b">DROPPED</strong> (without <code>gbp</code> flag)</td></tr>
  <tr><td><span class="badge badge-cisco">CISCO</span> sw3 (GBP OFF)</td><td><span class="badge badge-cumulus">CUMULUS</span></td><td><span style="color:#00875a">0x08</span></td><td><span class="badge badge-ok">OK</span></td></tr>
  <tr><td><span class="badge badge-cumulus">CUMULUS</span></td><td>Any VTEP</td><td><span style="color:#00875a">0x08</span></td><td><span class="badge badge-ok">OK</span></td></tr>
  <tr><td><span class="badge badge-cisco">CISCO</span> sw2 (GBP+SGT ON)</td><td><span class="badge badge-cisco">CISCO</span> sw3</td><td><strong style="color:#de350b">0x88</strong></td><td><span class="badge badge-ok">OK</span> (IOS-XE ignores GBP)</td></tr>
</table>

<div class="panel panel-info"><strong>Cisco IOS-XE Receivers: Not Affected</strong> IOS-XE silently ignores GBP bits and processes packets normally. This issue <strong>only affects Linux kernel VXLAN</strong> (Cumulus, Ubuntu, etc.).</div>

<div class="panel panel-warning"><strong>Cisco as a Sender: Same Impact as Versa</strong> When <code>group-based-policy</code> is enabled under <code>interface nve1</code> on Cisco Catalyst 9300, it sends VXLAN-GBP headers (flags=0x88) with SGT tag. This causes the <strong>exact same packet drops</strong> on Cumulus as Versa does. The issue is <strong>symmetric</strong> &mdash; any GBP sender triggers the Linux kernel drop.</div>

<!-- ==================== 12 ==================== -->
<h2 id="s12">12. VXLAN-GBP Fix &amp; Resolution</h2>

<table>
  <tr><th>Attribute</th><th>Detail</th></tr>
  <tr><td>Affected Traffic</td><td>Any GBP-sending VTEP &rarr; Cumulus Linux (data plane only)</td></tr>
  <tr><td>GBP Senders</td><td><strong>Cisco Catalyst 9300</strong> (with <code>group-based-policy</code> + CTS/SGT), <strong>Versa FlexVNF</strong> (GBP always on)</td></tr>
  <tr><td>Root Cause</td><td>Linux kernel VXLAN driver drops packets with G-bit set (flags=0x88) on non-GBP interfaces. Not vendor-specific.</td></tr>
  <tr><td>Control Plane</td><td>Not affected &mdash; BGP EVPN routes exchanged correctly</td></tr>
  <tr><td>Cisco as Receiver</td><td>Not affected &mdash; IOS-XE ignores GBP bits from other senders</td></tr>
  <tr><td>Cisco as Sender</td><td><strong>Causes same drop</strong> on Cumulus when SGT/GBP enabled (flags=0x88, SGT in GPID field)</td></tr>
  <tr><td>Fix Required On</td><td>Cumulus Linux (any Linux-based VTEP without <code>gbp</code> flag)</td></tr>
</table>

<h3>12.1 Step 1 &mdash; Recreate vxlan48 with GBP</h3>
<pre class="dark"><span style="color:#6a9955"># Delete existing</span>
sudo ip link del vxlan48

<span style="color:#6a9955"># Recreate with GBP flag</span>
sudo ip link add vxlan48 type vxlan id 401151 local 1.1.1.5 dstport 4789 nolearning <strong style="color:#4ec9b0">gbp</strong>
sudo ip link set vxlan48 up</pre>

<h3>12.2 Step 2 &mdash; Restore bridge and VLAN settings</h3>
<pre class="dark"><span style="color:#6a9955"># Add back to bridge</span>
sudo ip link set vxlan48 master br_default

<span style="color:#6a9955"># CRITICAL: Fix VLAN mapping (default PVID=1, must be 1151)</span>
sudo bridge vlan del vid 1 dev vxlan48
sudo bridge vlan add vid 1151 dev vxlan48 pvid untagged

<span style="color:#6a9955"># Restore bridge port settings</span>
sudo bridge link set dev vxlan48 state 3          <span style="color:#6a9955"># forwarding</span>
sudo ip link set vxlan48 mtu 9216                 <span style="color:#6a9955"># match fabric MTU</span>
sudo bridge link set dev vxlan48 learning off      <span style="color:#6a9955"># EVPN controls FDB</span>
sudo bridge link set dev vxlan48 neigh_suppress on <span style="color:#6a9955"># ARP suppression</span>
sudo bridge link set dev vxlan48 vlan_tunnel on</pre>

<h3>12.3 Step 3 &mdash; Sync with NVUE</h3>
<pre class="dark">nv config apply -y   <span style="color:#6a9955"># preserves GBP flag if vxlan48 already exists with it</span></pre>

<div class="panel panel-error">
<strong>VLAN Mapping Pitfall</strong>
When vxlan48 is manually recreated and added to <code>br_default</code>, the bridge assigns VLAN 1 as default PVID. This maps VNI 401151 to VLAN 1 instead of 1151, breaking <strong>ALL</strong> VXLAN traffic. You must explicitly delete VID 1 and set VID 1151 as PVID.
</div>

<div class="panel panel-warning">
<strong>Persistence</strong>
The manual <code>ip link</code> recreation is <strong>not persistent across reboots</strong>. NVUE does not currently expose a <code>gbp</code> option. Configure a post-boot script or edit <code>/etc/network/interfaces</code> to persist.
</div>

<h3>12.4 Post-Fix Verification</h3>
<pre>cumulus@cumulus:~$ ip -d link show vxlan48 | grep -i gbp
    vxlan id 401151 local 1.1.1.5 dstport 4789 nolearning ttl 64 udpcsum <strong>gbp</strong>

cumulus@cumulus:~$ bridge vlan show dev vxlan48
port     vlan ids
vxlan48  <strong>1151 PVID Egress Untagged</strong>

cumulus@cumulus:~$ sudo vtysh -c "show evpn vni 401151" | grep Vlan
 Vlan: <strong>1151</strong>          ← must be 1151, NOT 1</pre>

<div class="panel panel-success"><strong>Resolution Confirmed</strong> After enabling GBP, Cumulus accepts VXLAN-GBP packets from <strong>all</strong> GBP-sending VTEPs (Cisco with SGT and Versa). Traffic flows between all VTEPs.</div>

<!-- ==================== 13 ==================== -->
<h2 id="s13">13. Command Reference</h2>

<h3>Cisco IOS-XE</h3>
<table>
  <tr><th>Command</th><th>Purpose</th></tr>
  <tr><td><code>show bgp l2vpn evpn summary</code></td><td>BGP EVPN neighbor status</td></tr>
  <tr><td><code>show bgp l2vpn evpn route-type 2</code></td><td>MAC/IP routes (Type-2)</td></tr>
  <tr><td><code>show bgp l2vpn evpn route-type 3</code></td><td>IMET routes (Type-3)</td></tr>
  <tr><td><code>show nve peers</code></td><td>VXLAN tunnel peer status</td></tr>
  <tr><td><code>show nve vni</code></td><td>VNI status / mappings</td></tr>
  <tr><td><code>show l2vpn evpn mac evi &lt;id&gt;</code></td><td>EVPN learned MACs per EVI</td></tr>
  <tr><td><code>show l2vpn evpn evi detail</code></td><td>Detailed EVI information</td></tr>
  <tr><td><code>show l2fib bridge-domain &lt;vni&gt;</code></td><td>Data plane FDB entries</td></tr>
  <tr><td><code>show ip ospf neighbor</code></td><td>OSPF adjacency status</td></tr>
</table>

<h3>Cumulus Linux (NVIDIA)</h3>
<table>
  <tr><th>Command</th><th>Purpose</th></tr>
  <tr><td><code>sudo vtysh -c "show bgp l2vpn evpn summary"</code></td><td>BGP EVPN peers</td></tr>
  <tr><td><code>sudo vtysh -c "show bgp l2vpn evpn route vni &lt;id&gt;"</code></td><td>EVPN routes per VNI</td></tr>
  <tr><td><code>sudo vtysh -c "show evpn vni &lt;id&gt;"</code></td><td>VNI status (VLAN map, remote VTEPs)</td></tr>
  <tr><td><code>sudo vtysh -c "show evpn arp-cache vni &lt;id&gt;"</code></td><td>EVPN ARP/ND cache</td></tr>
  <tr><td><code>sudo vtysh -c "show evpn mac vni &lt;id&gt;"</code></td><td>EVPN MAC table per VNI</td></tr>
  <tr><td><code>bridge fdb show dev vxlan48</code></td><td>Bridge FDB (MAC table)</td></tr>
  <tr><td><code>bridge vlan show dev vxlan48</code></td><td>VLAN membership check</td></tr>
  <tr><td><code>ip -d link show vxlan48</code></td><td>VXLAN interface detail (check GBP)</td></tr>
  <tr><td><code>nv config show --output commands</code></td><td>Running config in set format</td></tr>
  <tr><td><code>sudo tcpdump -i swp1 udp port 4789 -nn</code></td><td>Capture VXLAN traffic</td></tr>
</table>

<h3>Versa FlexVNF</h3>
<table>
  <tr><th>Command</th><th>Purpose</th></tr>
  <tr><td><code>show bgp summary</code></td><td>BGP neighbor status</td></tr>
  <tr><td><code>show bridge</code></td><td>MAC address table</td></tr>
  <tr><td><code>show bridge-evpn</code></td><td>EVPN instance status</td></tr>
  <tr><td><code>show bridge-domain</code></td><td>Bridge domain details</td></tr>
  <tr><td><code>show ospf route routing-instance Underlay</code></td><td>OSPF routes</td></tr>
  <tr><td><code>ping &lt;ip&gt; routing-instance Underlay count 3</code></td><td>Ping from underlay VR</td></tr>
</table>

<div class="panel panel-warning"><strong>Note &mdash; Remote MACs on Cisco</strong> Remote MACs appear in <code>show l2vpn evpn mac</code> and <code>show l2fib bridge-domain</code>. They do <strong>NOT</strong> appear in <code>show mac address-table</code> (local MACs only). This is expected.</div>

<!-- ==================== 14 ==================== -->
<h2 id="s14">14. Lessons Learned</h2>

<table>
<tr><th>#</th><th>Issue</th><th>Impact</th><th>Resolution</th></tr>
<tr>
  <td>1</td>
  <td><strong>VXLAN-GBP Flag Mismatch</strong></td>
  <td>100% data plane failure from any GBP-sending VTEP (Cisco with SGT, Versa) to Cumulus. Linux kernel VXLAN driver behavior, not vendor-specific.</td>
  <td>Enable <code>gbp</code> on Cumulus VXLAN interface at creation time</td>
</tr>
<tr>
  <td>2</td>
  <td><strong>VLAN-VNI Mapping after VXLAN Recreation</strong></td>
  <td>VNI maps to VLAN 1 (default PVID) instead of 1151</td>
  <td><code>bridge vlan del vid 1</code> then <code>bridge vlan add vid 1151 pvid untagged</code></td>
</tr>
<tr>
  <td>3</td>
  <td><strong>OSPF MTU Mismatch</strong></td>
  <td>OSPF stuck in ExStart between Cisco (1550) and Cumulus (9216)</td>
  <td><code>ip ospf mtu-ignore</code> on both ends</td>
</tr>
<tr>
  <td>4</td>
  <td><strong>Cumulus NVUE OSPF Context</strong></td>
  <td>OSPF daemon won't activate</td>
  <td>Must use <code>nv set vrf default router ospf enable on</code></td>
</tr>
<tr>
  <td>5</td>
  <td><strong>Versa Route Target</strong></td>
  <td>Versa exports RT 2:2 + 1151:1</td>
  <td>All VTEPs import 1151:1 (matches). Optionally import 2:2.</td>
</tr>
</table>

<h3>Recommendations</h3>

<h4>For Linux-based VTEPs (Cumulus, Ubuntu, etc.)</h4>
<ul>
  <li><strong>Always create VXLAN interfaces with <code>gbp</code> flag</strong> when integrating with any GBP-capable VTEP (Cisco with SGT, Versa, or others)</li>
  <li>Without <code>gbp</code>, the Linux kernel silently drops GBP-flagged packets &mdash; no logs, no counters, extremely difficult to diagnose</li>
  <li><strong>GBP Persistence:</strong> Edit <code>/etc/network/interfaces</code> or create post-boot script. NVUE doesn't support <code>gbp</code> natively.</li>
  <li><strong>Monitoring:</strong> Check VXLAN flags after every <code>nv config apply</code> to ensure GBP preserved</li>
</ul>

<h4>For Cisco Catalyst 9300 with SGT/GBP</h4>
<ul>
  <li><strong>Enabling <code>group-based-policy</code> on NVE changes the VXLAN header format</strong> from standard (0x08) to GBP-extended (0x88)</li>
  <li>This will break connectivity to any Linux-based VTEP that lacks the <code>gbp</code> interface flag</li>
  <li>If SGT microsegmentation is not required, leave <code>group-based-policy</code> disabled to maintain standard VXLAN interoperability</li>
</ul>

<h4>For Multi-Vendor Fabrics</h4>
<ul>
  <li><strong>Test data plane connectivity after any GBP/SGT configuration change</strong> &mdash; control plane (BGP EVPN) will appear healthy even when data plane is completely broken</li>
  <li><strong>Packet Captures:</strong> Use <code>tcpdump -i &lt;intf&gt; -n 'udp port 4789' -XX</code> to verify VXLAN flags byte (0x08 = standard, 0x88 = GBP)</li>
  <li>The issue is <strong>symmetric</strong> &mdash; Cisco with SGT causes the same drop on Cumulus as Versa does</li>
  <li><strong>MTU:</strong> Standardize underlay MTU across all vendors</li>
</ul>

<hr style="margin:40px 0 20px;border:none;border-top:1px solid #dfe1e6">
<p style="text-align:center;font-size:12px;color:#6b778c"><strong>INTERNAL ENGINEERING DOCUMENT</strong><br>Multi-Vendor EVPN VXLAN &mdash; v2.1 &mdash; February 2026<br>Generated with Claude Code</p>

</div><!-- /main -->
</div><!-- /wiki-wrap -->

<script>
// Highlight active sidebar link on scroll
document.addEventListener('scroll',function(){
  var links=document.querySelectorAll('.sidebar a');
  var sections=[];
  links.forEach(function(l){
    var id=l.getAttribute('href');
    if(id&&id.startsWith('#')){var el=document.querySelector(id);if(el)sections.push({el:el,link:l})}
  });
  var cur=null;
  sections.forEach(function(s){if(s.el.getBoundingClientRect().top<=80)cur=s});
  links.forEach(function(l){l.classList.remove('active')});
  if(cur)cur.link.classList.add('active');
});
</script>

</body>
</html>
